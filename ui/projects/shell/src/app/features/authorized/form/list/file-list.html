<p-card class="w-full max-w-4xl">
    <div class="flex flex-col">

        @if(fileStore.files.value().total !== 0 || fileStore.filter.query()) {
        <div class="flex">
            <p-inputgroup>
                <p-inputgroup-addon>
                    <i class="pi pi-search"></i>
                </p-inputgroup-addon>
                <input class="w-full" pSize="small" [value]="query()" (input)="onInput(search.value)" #search pInputText
                    [placeholder]="'label.search'|translate" />
                <p-inputgroup-addon>
                    <p-button [disabled]="!query()" (onClick)="query$.next('')" icon="pi pi-times"
                        severity="secondary" />
                </p-inputgroup-addon>

            </p-inputgroup>
            <p-button [pTooltip]="'label.refresh'|translate"
                [disabled]="!fileStore.files.value().items.length || fileStore.isLoading()" [text]="true"
                icon="pi pi-refresh" (onClick)="fileStore.refresh()" severity="secondary" />
        </div>
        <!-- <div class="w-full px-2 text-sm text-gray-400">
            {{'utils.pagination'|translate:{
            value: fileStore.files.value().items.length,
            total: fileStore.files.value().total,
            entity: 'label.plural.files'|translate
            } }}
        </div> -->
        }

        <div class="flex flex-col w-full">
            @for(item of fileStore.files.value().items; track item.id) {
            <div [routerLink]="[item.filename]" #rla="routerLinkActive" [queryParams]="{}"
                [routerLinkActive]="'bg-highlight'" pRipple
                class="w-full flex hover:cursor-pointer items-center justify-between hover:bg-highlight hover:rounded-xl p-2">
                <div class="flex flex-col p-menu-item-link gap-0 w-full justify-start items-start">
                    <div class="flex w-full items-center">
                        <span class="pi pi-file"></span>
                        <span class="ml-2">{{ item.filename }}</span>
                    </div>
                    @if(item.lastModified) {
                    <div class="text-gray-400 text-sm text-left">
                        {{item.lastModified | date:('date.datetime'|translate)}}
                        <app-user [user]="item.user.username" />
                    </div>
                    }
                </div>
                <div class="flex gap-2 items-center">
                    @let count = item.messages.length ? item.messages.length +'':'';
                    <p-button badgeSeverity="danger" [badge]="count"
                        (onClick)="$event.stopPropagation(); chat.toggle($event)" icon="pi pi-comments" [text]="true" />
                    <p-button size="small" (onClick)="$event.stopPropagation(); op.toggle($event)" [text]="true"
                        icon="pi pi-ellipsis-v" />
                </div>
            </div>
            <p-popover #op>
                <div class="flex flex-col">
                    <p-button [label]="'action.edit'|translate" (onClick)="fileStore.editFile(item)" icon="pi pi-pencil"
                        [text]="true" />
                    <p-button [label]="'action.delete'|translate" (onClick)="fileStore.deleteFile($event,item.filename)"
                        icon="pi pi-trash" [text]="true" />

                </div>
            </p-popover>
            <p-popover #chat>
                <ng-template #content>
                    <app-chat class="flex flex-col w-[420px] max-w-full" [file]="item" [filename]="item.filename" />
                </ng-template>
            </p-popover>
            }
        </div>
        <div class="card flex justify-center">
            @if(fileStore.files.hasValue()) {
            <p-paginator [showCurrentPageReport]="true" [showPageLinks]="false" [showJumpToPageDropdown]="false"
                [currentPageReportTemplate]="'primeng.currentPageReportTemplate'|translate" appendTo="body"
                (onPageChange)="onPageChange($event)" [first]="fileStore.limit() * fileStore.offset()"
                [rows]="fileStore.limit()" [totalRecords]="fileStore.files.value().total"
                [rowsPerPageOptions]="[10, 20, 30]" />
            }
        </div>

        <p-divider class="mb-1" />
        <div class="flex px-2 w-full items-center">
            <p-fileupload [pTooltip]="'label.import'|translate" [auto]="true" [multiple]="true" mode="basic"
                [uploadButtonProps]="{label:''}" [chooseButtonProps]="{label:'',size:'large',text: true}"
                class="no-label" chooseIcon="pi pi-upload" name="import[]" accept="" maxFileSize="1000000"
                (onSelect)="onImport($event)" />
            <p-divider layout="vertical" />
            <p-button icon="pi pi-plus" class="w-full" styleClass="w-full" (onClick)="onCreateFile()"
                [label]="'utils.create.value'|translate:{value:'label.file.label'|translate}" severity="secondary"
                [text]="true" />
        </div>
    </div>
</p-card>